<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.ico"><link rel="mask-icon" href="/images/avatar.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/red/pace-theme-flash.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"blog.zebedy.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="Hexo 中主流使用 hexo-blog-encrypt 插件可以对文章进行加密。这种方法通过密码实现。相比更为简单的前端 JavaScript 密码比较验证，该方法的加密流程如下  Markdown 文章头部密码 → PBKDF2 派生密钥 → AES-256-CBC 加密原始内容 → 生成 HMAC 完整性校验 → 输出加密的 HTML  从而实现使用加密厚的内容替换原始内容，防止通过简单 J"><meta property="og:type" content="article"><meta property="og:title" content="Hexo 使用通行密钥对文章加密"><meta property="og:url" content="https://blog.zebedy.com/post/4de6100b.html"><meta property="og:site_name" content="Undefined"><meta property="og:description" content="Hexo 中主流使用 hexo-blog-encrypt 插件可以对文章进行加密。这种方法通过密码实现。相比更为简单的前端 JavaScript 密码比较验证，该方法的加密流程如下  Markdown 文章头部密码 → PBKDF2 派生密钥 → AES-256-CBC 加密原始内容 → 生成 HMAC 完整性校验 → 输出加密的 HTML  从而实现使用加密厚的内容替换原始内容，防止通过简单 J"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://images.zabrian.com/85d3037a-fadf-4e98-8ee2-d84196e8ce01/origin"><meta property="og:image" content="https://images.zabrian.com/bf70281b-6855-47bb-84b8-69fcb164db01/origin"><meta property="article:published_time" content="2025-10-08T07:19:49.000Z"><meta property="article:modified_time" content="2025-10-15T01:23:44.000Z"><meta property="article:author" content="Zebedy"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://images.zabrian.com/85d3037a-fadf-4e98-8ee2-d84196e8ce01/origin"><link rel="canonical" href="https://blog.zebedy.com/post/4de6100b.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.zebedy.com/post/4de6100b.html","path":"post/4de6100b.html","title":"Hexo 使用通行密钥对文章加密"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Hexo 使用通行密钥对文章加密 | Undefined</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-EV574LFH56"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-EV574LFH56","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Undefined" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Undefined</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Life is but a span</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>订阅</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="nav-text">整体思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%B7%E5%90%88%E5%8A%A0%E5%AF%86-Hybrid-Encryption"><span class="nav-text">混合加密 (Hybrid Encryption)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2"><span class="nav-text">测试页面</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97"><span class="nav-text">食用指南</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-text">站点配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C-FIDO2-%E6%B5%81%E7%A8%8B"><span class="nav-text">注册 FIDO2 流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%AF%86%E6%B5%81%E7%A8%8B"><span class="nav-text">加密流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86%E6%B5%81%E7%A8%8B"><span class="nav-text">解密流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E9%9B%B6%E5%85%AB%E7%A2%8E"><span class="nav-text">七零八碎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E8%A1%A5-head-unique-njk"><span class="nav-text">修补 head-unique.njk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E8%A1%A5-post-njk"><span class="nav-text">修补 post.njk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E8%A1%A5-post-collapse-njk"><span class="nav-text">修补 post-collapse.njk</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Zebedy" src="https://images.zabrian.com/3df4d5a1-6f7e-44b0-33b8-b49273c8ef01/origin"><p class="site-author-name" itemprop="name">Zebedy</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">日志</span></a></div></nav></div></div></div><div class="twopeople"><div class="container" style="height:200px"><canvas class="illo" width="800" height="800" style="max-width:200px;max-height:200px;touch-action:none;width:640px;height:640px"></canvas></div><script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople1.js"></script><script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/zdog.dist.js"></script><script id="rendered-js" src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople.js"></script><style>.twopeople{margin:0;align-items:center;justify-content:center;text-align:center}canvas{display:block;margin:0 auto;cursor:move}</style></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.zebedy.com/post/4de6100b.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://images.zabrian.com/3df4d5a1-6f7e-44b0-33b8-b49273c8ef01/origin"><meta itemprop="name" content="Zebedy"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Undefined"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Hexo 使用通行密钥对文章加密</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-10-08 15:19:49" itemprop="dateCreated datePublished" datetime="2025-10-08T15:19:49+08:00">2025-10-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-10-15 09:23:44" itemprop="dateModified" datetime="2025-10-15T09:23:44+08:00">2025-10-15</time> </span><span class="post-meta-item" title="阅读次数" id="vercount_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="vercount_value_page_pv"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>40k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>37 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>Hexo 中主流使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0QwbjlYMW4vaGV4by1ibG9nLWVuY3J5cHQ=">hexo-blog-encrypt<i class="fa fa-external-link-alt"></i></span> 插件可以对文章进行加密。这种方法通过密码实现。相比更为简单的前端 JavaScript 密码比较验证，该方法的加密流程如下</p><ul><li>Markdown 文章头部密码 → PBKDF2 派生密钥 → AES-256-CBC 加密原始内容 → 生成 HMAC 完整性校验 → 输出加密的 HTML</li></ul><p>从而实现使用加密厚的内容替换原始内容，防止通过简单 JavaScript 手段直接跳过密码验证。同时解密过程则是</p><ul><li>用户输入密码 → PBKDF2 派生密钥 → 验证 HMAC → AES-256-CBC 解密 → 获取原始 HTML 内容 → 渲染文章内容</li></ul><span id="more"></span><p>这种方案的好处是简单易用，对于需要保密的文章内容，只需要在使用插件并在文章头部增加密码即可。但是作为一个会点技术的折腾党怎么满足于每次手动输入密码？看着现在各大网站推行的通行密钥，登录只需要触摸一下 TouchID 的快感确实是传统输入密码不能比拟的。所以就在国庆期间好好探索了一下其可行性，最终也是在静态博客中用上了一触即达的通行密钥。</p><h1 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h1><img data-src="https://images.zabrian.com/85d3037a-fadf-4e98-8ee2-d84196e8ce01/origin" style="zoom:16%"><h1 id="混合加密-Hybrid-Encryption"><a href="#混合加密-Hybrid-Encryption" class="headerlink" title="混合加密 (Hybrid Encryption)"></a>混合加密 (Hybrid Encryption)</h1><img data-src="https://images.zabrian.com/bf70281b-6855-47bb-84b8-69fcb164db01/origin" style="zoom:23%"><div class="note info"><p><strong>Q</strong>: 为什么使用混合加密而不是直接用 FIDO2 密钥加密？<br><strong>A</strong>: <strong>支持多设备</strong></p><p><strong>Q</strong>: PRF Salt 必须保密吗？<br><strong>A</strong>: <strong>不需要</strong> 因为 PRF Salt 的作用是为了 <strong>跨域一致性</strong></p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 相同 FIDO2 设备 + 相同 Salt → 相同密钥</span></span><br><span class="line">wrappingKey = <span class="title class_">FIDO2</span>_PRF(hardware_key, prfSalt)</span><br><span class="line">                             ↑           ↑</span><br><span class="line">                           保密的       公开的</span><br></pre></td></tr></table></figure><ul><li>PRF Salt &#x3D; 盐值（公开）</li><li>Hardware Key &#x3D; 密码（保密）</li></ul><p>即使知道 Salt，硬件密钥一般仅存在 FIDO2 设备中无法导出，因此没有硬件密钥仍然无法派生出 wrappingKey</p><p><strong>Q</strong>: 下载了我的博客 HTML，能破解吗？<br><strong>A</strong>: <strong>不能</strong>，原因如下</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">从 HTML 可以获得:</span><br><span class="line"><span class="bullet"> 1.</span> 加密的文章内容 (ciphertext)</span><br><span class="line"><span class="bullet"> 2.</span> 初始化向量 (iv, authTag)</span><br><span class="line"><span class="bullet"> 3.</span> 包装后的 CEK (wrappedKeys)</span><br><span class="line"><span class="bullet"> 4.</span> PRF Salt</span><br><span class="line"></span><br><span class="line">不能获得：</span><br><span class="line">  包装密钥 (wrappingKey)</span><br><span class="line"><span class="code">     └─ 使用 AES-256-GCM 加密，安全性目前尚可</span></span><br></pre></td></tr></table></figure></div><h1 id="测试页面"><a href="#测试页面" class="headerlink" title="测试页面"></a>测试页面</h1><a href="/post/19c1a188.html" title="测试加密文章">测试加密文章</a><p>密码: <code>123456</code></p><div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start"><div style="position:relative;flex:1 1 480px;max-width:100%;aspect-ratio:100/52.96875"><iframe src="https://customer-fonbnn17ffsh6xbx.cloudflarestream.com/a8621952cca955db2b06c529a54ac473/iframe?preload=true&loop=true&autoplay=true&title=%E9%80%9A%E8%A1%8C%E5%AF%86%E9%92%A5%E9%AA%8C%E8%AF%81" loading="lazy" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen></iframe></div><div style="position:relative;flex:1 1 480px;max-width:100%;aspect-ratio:100/52.96875"><iframe src="https://customer-fonbnn17ffsh6xbx.cloudflarestream.com/2da0cc46efa7b773d05561cfe24a1437/iframe?preload=true&loop=true&autoplay=true&title=%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81" loading="lazy" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen></iframe></div></div><h1 id="食用指南"><a href="#食用指南" class="headerlink" title="食用指南"></a>食用指南</h1><div class="note danger"><p>注意: 以下代码只针对 NexT 主题修改，如果使用的不是 NexT 主题则需要自行根据需要针对性修改</p></div><h2 id="站点配置"><a href="#站点配置" class="headerlink" title="站点配置"></a>站点配置</h2><figure class="highlight yml"><figcaption><span>站点 _config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">encryption:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span>   <span class="comment"># 启用加密</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line">  <span class="comment"># 解密后缓存时长 (分钟)</span></span><br><span class="line">  <span class="comment"># 默认 0 表示不缓存，即每次刷新页面后都需要重新认证</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line">  <span class="attr">cache:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line">  <span class="comment"># 64 位盐值</span></span><br><span class="line">  <span class="comment"># 可通过 openssl rand -hex 32 生成</span></span><br><span class="line">  <span class="comment"># 修改后需要重新注册 FIDO2 设备</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line">  <span class="attr">salt:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------   </span></span><br><span class="line">  <span class="comment"># FIDO2 设备注册后生成的 key (切勿泄露!!) </span></span><br><span class="line">  <span class="comment"># 如果注册多个 key 则在下方依次添加即可</span></span><br><span class="line">  <span class="comment"># 每添加一个新 key 需要重新 generate 并部署才能生效</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line">  <span class="attr">keys:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><h2 id="注册-FIDO2-流程"><a href="#注册-FIDO2-流程" class="headerlink" title="注册 FIDO2 流程"></a>注册 FIDO2 流程</h2><ul><li><code>./source/register.html</code> (新增)</li></ul><div class="note info"><p>注意: 注册页面中需要填写 <code>站点 _config.yml</code> 中使用的 <code>salt</code></p></div><div class="tabs" id="注册-fido2-流程"><ul class="nav-tabs"><li class="tab active"><a href="#注册-fido2-流程-1"><i class="fa fa-code"></i>./source/register.html</a></li></ul><div class="tab-content"><div class="tab-pane active" id="注册-fido2-流程-1"><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>注册通行密钥<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span></span></span><br><span class="line"><span class="tag">      <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">      * &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-family</span>: -apple-system, <span class="string">&quot;PingFang SC&quot;</span>, <span class="string">&quot;Microsoft YaHei&quot;</span>, <span class="string">&quot;sans-serif&quot;</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">align-items</span>: flex-start;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">60px</span> <span class="number">20px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">max-width</span>: <span class="number">650px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">28px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.subtitle</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.register-btn</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#059669</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-weight</span>: <span class="number">600</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">transition</span>: all <span class="number">0.3s</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.register-btn</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:disabled</span>) &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#047857</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.register-btn</span><span class="selector-pseudo">:disabled</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">opacity</span>: <span class="number">0.5</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">cursor</span>: not-allowed;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#9ca3af</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.register-btn</span> <span class="selector-tag">i</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#status</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-top</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: none;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.note</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-top</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.note</span><span class="selector-class">.success</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#d4edda</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#c3e6cb</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: <span class="number">#155724</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.note</span><span class="selector-class">.danger</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#f8d7da</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#f5c6cb</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: <span class="number">#721c24</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.note</span><span class="selector-class">.info</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#d1ecf1</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#bee5eb</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: <span class="number">#0c5460</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.note</span> <span class="selector-tag">code</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#f5f5f5</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-family</span>: <span class="string">&quot;Monaco&quot;</span>, <span class="string">&quot;Courier New&quot;</span>, monospace;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">user-select</span>: all;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">word-break</span>: break-all;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">10px</span> auto;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.copy-btn</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">8px</span> <span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#0284c7</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">10px</span> auto <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.copy-btn</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="number">#0369a1</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.copy-btn</span> <span class="selector-tag">i</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-right</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.salt-container</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.salt-container</span> <span class="selector-tag">label</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-bottom</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">color</span>: <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.salt-container</span> <span class="selector-tag">input</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">13px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-family</span>: monospace;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>注册通行密钥<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;subtitle&quot;</span>&gt;</span></span><br><span class="line">        使用 YubiKey、Touch ID 或其他 FIDO2 设备保护您的加密内容</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;salt-container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;prf-salt-input&quot;</span></span></span><br><span class="line"><span class="tag">          &gt;</span>PRF Salt <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color: #ef4444&quot;</span>&gt;</span>*<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;/label</span><br><span class="line">        &gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;prf-salt-input&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;&quot;</span> <span class="attr">required</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;register-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;register-btn&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-key&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 开始注册</span><br><span class="line">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">getRPID</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> hostname = location.<span class="property">hostname</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> hostname === <span class="string">&quot;127.0.0.1&quot;</span> ? <span class="string">&quot;localhost&quot;</span> : hostname;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">class</span> <span class="title class_">FIDO2Registrar</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">btn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;register-btn&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">saltInput</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;prf-salt-input&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">onclick</span> = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">register</span>();</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">saltInput</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;input&quot;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">validateInput</span>());</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="title function_">validateInput</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">validateInput</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> isValid = <span class="variable language_">this</span>.<span class="property">saltInput</span>.<span class="property">value</span>.<span class="title function_">trim</span>().<span class="property">length</span> &gt; <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">disabled</span> = !isValid;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">disabled</span> = <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">PublicKeyCredential</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">show</span>(</span></span><br><span class="line"><span class="language-javascript">              <span class="string">&#x27;&lt;div class=&quot;note danger&quot;&gt;&lt;p&gt;浏览器不支持 FIDO2/WebAuthn&lt;/p&gt;&lt;/div&gt;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">this</span>.<span class="title function_">show</span>(<span class="string">&#x27;&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;正在注册通行密钥...&lt;/p&gt;&lt;/div&gt;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> userId = crypto.<span class="title function_">getRandomValues</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">32</span>));</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> challenge = crypto.<span class="title function_">getRandomValues</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">32</span>));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> cred = <span class="keyword">await</span> navigator.<span class="property">credentials</span>.<span class="title function_">create</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="attr">publicKey</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                challenge,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">rp</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">name</span>: <span class="string">&quot;Undefined Blog&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">id</span>: <span class="title function_">getRPID</span>(),</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">user</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">id</span>: userId,</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">name</span>: <span class="string">&quot;Zabrian&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">displayName</span>: <span class="string">&quot;Zabrian&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">pubKeyCredParams</span>: [</span></span><br><span class="line"><span class="language-javascript">                  &#123; <span class="attr">alg</span>: -<span class="number">7</span>, <span class="attr">type</span>: <span class="string">&quot;public-key&quot;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">                  &#123; <span class="attr">alg</span>: -<span class="number">257</span>, <span class="attr">type</span>: <span class="string">&quot;public-key&quot;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">                ],</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">authenticatorSelection</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">residentKey</span>: <span class="string">&quot;required&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">userVerification</span>: <span class="string">&quot;preferred&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">requireResidentKey</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">timeout</span>: <span class="number">60000</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">extensions</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">prf</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">              &#125;,</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!cred) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;生成凭证失败&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> prfEnabled = cred.<span class="title function_">getClientExtensionResults</span>().<span class="property">prf</span>?.<span class="property">enabled</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!prfEnabled) &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="variable language_">this</span>.<span class="title function_">show</span>(<span class="string">&#x27;&lt;div class=&quot;note danger&quot;&gt;&lt;p&gt;PRF 扩展不可用&lt;/p&gt;&lt;/div&gt;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">              <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">              <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">generateEncryptionKey</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">          &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> msg = <span class="string">&quot;注册失败: &quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (e.<span class="property">name</span> === <span class="string">&quot;NotAllowedError&quot;</span>) msg += <span class="string">&quot;操作取消&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">name</span> === <span class="string">&quot;InvalidStateError&quot;</span>) msg += <span class="string">&quot;重复注册&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">else</span> msg += e.<span class="property">message</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">show</span>(<span class="string">`&lt;div class=&quot;note danger&quot;&gt;&lt;p&gt;<span class="subst">$&#123;msg&#125;</span>&lt;/p&gt;&lt;/div&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">          &#125; <span class="keyword">finally</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">btn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="title function_">generateEncryptionKey</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> prfSaltString = <span class="variable language_">this</span>.<span class="property">saltInput</span>.<span class="property">value</span>.<span class="title function_">trim</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">show</span>(</span></span><br><span class="line"><span class="language-javascript">              <span class="string">&#x27;&lt;div class=&quot;note info&quot;&gt;&lt;p&gt;正在生成加密密钥...&lt;/p&gt;&lt;/div&gt;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> challenge = crypto.<span class="title function_">getRandomValues</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">32</span>));</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> prfSalt = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">digest</span>(</span></span><br><span class="line"><span class="language-javascript">              <span class="string">&quot;SHA-256&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">              <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(prfSaltString)</span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> assertion = <span class="keyword">await</span> navigator.<span class="property">credentials</span>.<span class="title function_">get</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="attr">publicKey</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                challenge,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">rpId</span>: <span class="title function_">getRPID</span>(),</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">userVerification</span>: <span class="string">&quot;preferred&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">timeout</span>: <span class="number">60000</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">extensions</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="attr">prf</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">eval</span>: &#123; <span class="attr">first</span>: prfSalt &#125;,</span></span><br><span class="line"><span class="language-javascript">                  &#125;,</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">              &#125;,</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> prfKey =</span></span><br><span class="line"><span class="language-javascript">              assertion.<span class="title function_">getClientExtensionResults</span>().<span class="property">prf</span>?.<span class="property">results</span>?.<span class="property">first</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!prfKey) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;无法获取 PRF 密钥&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> encryptionKey = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(prfKey);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> encryptionKeyHex = <span class="title class_">Array</span>.<span class="title function_">from</span>(encryptionKey)</span></span><br><span class="line"><span class="language-javascript">              .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span></span><br><span class="line"><span class="language-javascript">              .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">show</span>(<span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">              &lt;div class=&quot;note success&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                &lt;p&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                  &lt;code id=&quot;encryption-key&quot;&gt;<span class="subst">$&#123;encryptionKeyHex&#125;</span>&lt;/code&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                  &lt;button class=&quot;copy-btn&quot; onclick=&quot;copyEncryptionKey(event)&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;i class=&quot;fa fa-copy&quot;&gt;&lt;/i&gt; 复制密钥</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                  &lt;/button&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                &lt;/p&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">              &lt;/div&gt;`</span>);</span></span><br><span class="line"><span class="language-javascript">          &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">show</span>(</span></span><br><span class="line"><span class="language-javascript">              <span class="string">`&lt;div class=&quot;note danger&quot;&gt;&lt;p&gt;生成密钥失败: <span class="subst">$&#123;e.message&#125;</span>&lt;/p&gt;&lt;/div&gt;`</span></span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">show</span>(<span class="params">html</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;status&quot;</span>).<span class="property">innerHTML</span> = html;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;status&quot;</span>).<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;block&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">copyEncryptionKey</span>(<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> key = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;encryption-key&quot;</span>).<span class="property">textContent</span>;</span></span><br><span class="line"><span class="language-javascript">        navigator.<span class="property">clipboard</span>.<span class="title function_">writeText</span>(key).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> btn = event.<span class="property">target</span>.<span class="title function_">closest</span>(<span class="string">&quot;button&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> originalText = btn.<span class="property">innerHTML</span>;</span></span><br><span class="line"><span class="language-javascript">          btn.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;i class=&quot;fa fa-check&quot;&gt;&lt;/i&gt; 已复制&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            btn.<span class="property">innerHTML</span> = originalText;</span></span><br><span class="line"><span class="language-javascript">          &#125;, <span class="number">2000</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">FIDO2Registrar</span>());</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div></div><h2 id="加密流程"><a href="#加密流程" class="headerlink" title="加密流程"></a>加密流程</h2><ul><li><code>./scripts/post-encrypt.js</code> (新增)</li></ul><div class="tabs" id="加密流程"><ul class="nav-tabs"><li class="tab active"><a href="#加密流程-1"><i class="fa fa-code"></i>./scripts/post-encrypt.js</a></li></ul><div class="tab-content"><div class="tab-pane active" id="加密流程-1"><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">PBKDF2</span>_ITERATIONS = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">encrypt</span>(<span class="params">text, masterKey</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> iv = crypto.<span class="title function_">randomBytes</span>(<span class="number">12</span>);</span><br><span class="line">  <span class="keyword">const</span> keyBuffer = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(masterKey, <span class="string">&quot;hex&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> cipher = crypto.<span class="title function_">createCipheriv</span>(<span class="string">&quot;aes-256-gcm&quot;</span>, keyBuffer, iv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> encrypted = cipher.<span class="title function_">update</span>(text, <span class="string">&quot;utf8&quot;</span>, <span class="string">&quot;base64&quot;</span>);</span><br><span class="line">  encrypted += cipher.<span class="title function_">final</span>(<span class="string">&quot;base64&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">ciphertext</span>: encrypted,</span><br><span class="line">    <span class="attr">iv</span>: iv.<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">    <span class="attr">authTag</span>: cipher.<span class="title function_">getAuthTag</span>().<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">encryptCEK</span>(<span class="params">cek, wrapKey</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> iv = crypto.<span class="title function_">randomBytes</span>(<span class="number">12</span>);</span><br><span class="line">  <span class="keyword">const</span> keyBuffer = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(wrapKey, <span class="string">&quot;hex&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> cipher = crypto.<span class="title function_">createCipheriv</span>(<span class="string">&quot;aes-256-gcm&quot;</span>, keyBuffer, iv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> encrypted = cipher.<span class="title function_">update</span>(cek);</span><br><span class="line">  encrypted = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([encrypted, cipher.<span class="title function_">final</span>()]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;fido2&quot;</span>,</span><br><span class="line">    <span class="attr">encryptedCEK</span>: encrypted.<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">    <span class="attr">iv</span>: iv.<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">    <span class="attr">authTag</span>: cipher.<span class="title function_">getAuthTag</span>().<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">derivePBKDF2Key</span>(<span class="params">password, salt, iterations</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">pbkdf2Sync</span>(</span><br><span class="line">    <span class="title class_">Buffer</span>.<span class="title function_">from</span>(password, <span class="string">&quot;utf8&quot;</span>),</span><br><span class="line">    <span class="title class_">Buffer</span>.<span class="title function_">from</span>(salt, <span class="string">&quot;utf8&quot;</span>),</span><br><span class="line">    iterations,</span><br><span class="line">    <span class="number">32</span>,</span><br><span class="line">    <span class="string">&quot;sha256&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">encryptCEKWithPassword</span>(<span class="params">cek, password, salt, iterations</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> wrapKey = <span class="title function_">derivePBKDF2Key</span>(password, salt, iterations);</span><br><span class="line">  <span class="keyword">const</span> iv = crypto.<span class="title function_">randomBytes</span>(<span class="number">12</span>);</span><br><span class="line">  <span class="keyword">const</span> cipher = crypto.<span class="title function_">createCipheriv</span>(<span class="string">&quot;aes-256-gcm&quot;</span>, wrapKey, iv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> encrypted = cipher.<span class="title function_">update</span>(cek);</span><br><span class="line">  encrypted = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([encrypted, cipher.<span class="title function_">final</span>()]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">    <span class="attr">encryptedCEK</span>: encrypted.<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">    <span class="attr">iv</span>: iv.<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">    <span class="attr">authTag</span>: cipher.<span class="title function_">getAuthTag</span>().<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>),</span><br><span class="line">    <span class="attr">salt</span>: salt,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">genTemplate</span>(<span class="params">abbrlink, encData, wrappedKeys, prfSalt, cache, passwordHint</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> wrappedKeysJson = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(wrappedKeys).<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&quot;&amp;quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> hasFido2 = wrappedKeys.<span class="title function_">some</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> k.<span class="property">type</span> === <span class="string">&quot;fido2&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> hasPassword = wrappedKeys.<span class="title function_">some</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> k.<span class="property">type</span> === <span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fido2Html = hasFido2</span><br><span class="line">    ? <span class="string">`&lt;button class=&quot;decrypt-btn&quot; id=&quot;fido2-verify-btn&quot;&gt;&lt;i class=&quot;fa fa-fingerprint&quot;&gt;&lt;/i&gt; 通行密钥验证&lt;/button&gt;`</span></span><br><span class="line">    : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> passwordHtml = hasPassword</span><br><span class="line">    ? <span class="string">`&lt;div class=&quot;password-decrypt-group&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;button class=&quot;decrypt-btn&quot; id=&quot;show-password-btn&quot;&gt;&lt;i class=&quot;fa fa-lock&quot;&gt;&lt;/i&gt; 密码验证&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;password-input-group&quot; id=&quot;password-input-group&quot; style=&quot;display:none&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;input type=&quot;password&quot; class=&quot;password-input&quot; id=&quot;password-input&quot; placeholder=&quot;输入密码&quot; /&gt;</span></span><br><span class="line"><span class="string">          &lt;button class=&quot;decrypt-btn&quot; id=&quot;password-decrypt-btn&quot;&gt;&lt;i class=&quot;fa fa-key&quot;&gt;&lt;/i&gt; 确定&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;`</span></span><br><span class="line">    : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;div class=&quot;encrypted-post-container&quot; </span></span><br><span class="line"><span class="string">    data-ciphertext=&quot;<span class="subst">$&#123;encData.ciphertext&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    data-iv=&quot;<span class="subst">$&#123;encData.iv&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    data-auth-tag=&quot;<span class="subst">$&#123;encData.authTag&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    data-abbrlink=&quot;<span class="subst">$&#123;abbrlink || <span class="string">&quot;&quot;</span>&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    data-wrapped-keys=&#x27;<span class="subst">$&#123;wrappedKeysJson&#125;</span>&#x27;</span></span><br><span class="line"><span class="string">    data-prf-salt=&quot;<span class="subst">$&#123;prfSalt&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    data-cache=&quot;<span class="subst">$&#123;cache || <span class="number">0</span>&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    data-password-hint=&quot;<span class="subst">$&#123;passwordHint || <span class="string">&quot;&quot;</span>&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;encrypted-post-notice&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;decrypt-methods&quot;&gt;<span class="subst">$&#123;fido2Html&#125;</span><span class="subst">$&#123;passwordHtml&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;verification-status&quot; id=&quot;verification-status&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;decrypted-content&quot; id=&quot;decrypted-content&quot; style=&quot;display:none&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;`</span>.<span class="title function_">trim</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getKeys</span>(<span class="params">cfg</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">isArray</span>(cfg.<span class="property">keys</span>) ? cfg.<span class="property">keys</span> : cfg.<span class="property">key</span> ? [cfg.<span class="property">key</span>] : [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateConfig</span>(<span class="params">cfg</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!cfg?.<span class="property">enabled</span>) &#123;</span><br><span class="line">    hexo.<span class="property">log</span>.<span class="title function_">warn</span>(<span class="string">&quot;加密功能未启用&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!cfg.<span class="property">salt</span> || !<span class="regexp">/^[a-fA-F0-9]&#123;64&#125;$/</span>.<span class="title function_">test</span>(cfg.<span class="property">salt</span>)) &#123;</span><br><span class="line">    hexo.<span class="property">log</span>.<span class="title function_">error</span>(<span class="string">&quot;PRF Salt 配置无效&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="title function_">getKeys</span>(cfg);</span><br><span class="line">  <span class="keyword">if</span> (keys.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    hexo.<span class="property">log</span>.<span class="title function_">error</span>(<span class="string">&quot;请先注册 FIDO2 通行密钥&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> keys) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/^[a-fA-F0-9]&#123;64&#125;$/</span>.<span class="title function_">test</span>(key)) &#123;</span><br><span class="line">      hexo.<span class="property">log</span>.<span class="title function_">error</span>(<span class="string">`密钥格式无效: <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">&quot;after_post_render&quot;</span>,</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!data.<span class="property">encrypted</span>) <span class="keyword">return</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cfg = hexo.<span class="property">config</span>.<span class="property">encryption</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">validateConfig</span>(cfg)) <span class="keyword">return</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> cek = crypto.<span class="title function_">randomBytes</span>(<span class="number">32</span>);</span><br><span class="line">      <span class="keyword">const</span> encData = <span class="title function_">encrypt</span>(data.<span class="property">content</span>, cek.<span class="title function_">toString</span>(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line">      <span class="keyword">const</span> wrappedKeys = <span class="title function_">getKeys</span>(cfg).<span class="title function_">map</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> <span class="title function_">encryptCEK</span>(cek, key));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (data.<span class="property">password</span>) &#123;</span><br><span class="line">        wrappedKeys.<span class="title function_">push</span>(</span><br><span class="line">          <span class="title function_">encryptCEKWithPassword</span>(</span><br><span class="line">            cek,</span><br><span class="line">            <span class="title class_">String</span>(data.<span class="property">password</span>),</span><br><span class="line">            <span class="title class_">String</span>(cfg.<span class="property">salt</span>),</span><br><span class="line">            <span class="title class_">PBKDF2</span>_ITERATIONS</span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      data.<span class="property">content</span> = <span class="title function_">genTemplate</span>(</span><br><span class="line">        data.<span class="property">abbrlink</span>,</span><br><span class="line">        encData,</span><br><span class="line">        wrappedKeys,</span><br><span class="line">        cfg.<span class="property">salt</span>,</span><br><span class="line">        cfg.<span class="property">cache</span>,</span><br><span class="line">        data.<span class="property">password_hint</span></span><br><span class="line">      );</span><br><span class="line">      hexo.<span class="property">log</span>.<span class="title function_">info</span>(<span class="string">`Encrypted: <span class="subst">$&#123;data.title&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      hexo.<span class="property">log</span>.<span class="title function_">error</span>(<span class="string">`Encrypted: <span class="subst">$&#123;data.title&#125;</span> <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">15</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></div></div></div><h2 id="解密流程"><a href="#解密流程" class="headerlink" title="解密流程"></a>解密流程</h2><ul><li><code>./source/js/decrypt.js</code> (新增)</li><li><code>./source/_data/styles.styl</code> (新增)</li></ul><div class="tabs" id="解密流程"><ul class="nav-tabs"><li class="tab active"><a href="#解密流程-1"><i class="fa fa-code"></i>./source/js/decrypt.js</a></li><li class="tab"><a href="#解密流程-2"><i class="fa fa-code"></i>./source/_data/styles.styl</a></li></ul><div class="tab-content"><div class="tab-pane active" id="解密流程-1"><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">PBKDF2</span>_ITERATIONS = <span class="number">500000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getRPID</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hostname = location.<span class="property">hostname</span>;</span><br><span class="line">  <span class="keyword">return</span> hostname === <span class="string">&quot;127.0.0.1&quot;</span> ? <span class="string">&quot;localhost&quot;</span> : hostname;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Decryptor</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rpId</span> = <span class="title function_">getRPID</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">container</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;.encrypted-post-container&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">container</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = &#123;</span><br><span class="line">      <span class="attr">ciphertext</span>: <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">ciphertext</span>,</span><br><span class="line">      <span class="attr">iv</span>: <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">iv</span>,</span><br><span class="line">      <span class="attr">authTag</span>: <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">authTag</span>,</span><br><span class="line">      <span class="attr">abbrlink</span>: <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">abbrlink</span>,</span><br><span class="line">      <span class="attr">wrappedKeys</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">wrappedKeys</span> || <span class="string">&quot;[]&quot;</span>),</span><br><span class="line">      <span class="attr">prfSalt</span>: <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">prfSalt</span>,</span><br><span class="line">      <span class="attr">cache</span>: <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">cache</span>) || <span class="number">0</span>,</span><br><span class="line">      <span class="attr">passwordHint</span>: <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">dataset</span>.<span class="property">passwordHint</span> || <span class="string">&quot;&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">checkCache</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> fido2Btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;fido2-verify-btn&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fido2Btn) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">PublicKeyCredential</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;浏览器不支持 FIDO2/WebAuthn&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fido2Btn.<span class="property">onclick</span> = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">authenticate</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> showPasswordBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;show-password-btn&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (showPasswordBtn) &#123;</span><br><span class="line">      showPasswordBtn.<span class="property">onclick</span> = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">showPasswordInput</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> passwordBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-decrypt-btn&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (passwordBtn) &#123;</span><br><span class="line">      passwordBtn.<span class="property">onclick</span> = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">decryptWithPassword</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> passwordInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-input&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (passwordInput) &#123;</span><br><span class="line">      passwordInput.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&quot;Enter&quot;</span>) <span class="variable language_">this</span>.<span class="title function_">decryptWithPassword</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getCacheKey</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">abbrlink</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showPasswordInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> showBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;show-password-btn&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> inputGroup = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-input-group&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> passwordInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-input&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (showBtn) showBtn.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (inputGroup) inputGroup.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;flex&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">passwordHint</span>) <span class="variable language_">this</span>.<span class="title function_">showPasswordHint</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (passwordInput) &#123;</span><br><span class="line">      passwordInput.<span class="title function_">focus</span>();</span><br><span class="line">      passwordInput.<span class="title function_">addEventListener</span>(<span class="string">&quot;input&quot;</span>, <span class="function">() =&gt;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updatePasswordButtonState</span>()</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updatePasswordButtonState</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showPasswordHint</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> inputGroup = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-input-group&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!inputGroup) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hintElement = inputGroup.<span class="title function_">querySelector</span>(<span class="string">&quot;.password-hint&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hintElement) &#123;</span><br><span class="line">      hintElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">      hintElement.<span class="property">className</span> = <span class="string">&quot;password-hint&quot;</span>;</span><br><span class="line">      inputGroup.<span class="title function_">appendChild</span>(hintElement);</span><br><span class="line">    &#125;</span><br><span class="line">    hintElement.<span class="property">textContent</span> = <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">passwordHint</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updatePasswordButtonState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> passwordInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-input&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> passwordBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-decrypt-btn&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!passwordInput || !passwordBtn) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasPassword = passwordInput.<span class="property">value</span>.<span class="title function_">trim</span>().<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">    passwordBtn.<span class="property">disabled</span> = !hasPassword;</span><br><span class="line">    passwordBtn.<span class="property">style</span>.<span class="property">opacity</span> = hasPassword ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0.5&quot;</span>;</span><br><span class="line">    passwordBtn.<span class="property">style</span>.<span class="property">cursor</span> = hasPassword ? <span class="string">&quot;pointer&quot;</span> : <span class="string">&quot;not-allowed&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">checkCache</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">cache</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> cached = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="variable language_">this</span>.<span class="title function_">getCacheKey</span>());</span><br><span class="line">      <span class="keyword">if</span> (!cached) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; html, expired &#125; = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(cached);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() &lt; expired) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>(html);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">hideStatus</span>(), <span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="variable language_">this</span>.<span class="title function_">getCacheKey</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (_) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">saveCache</span>(<span class="params">html</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">cache</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> expired = <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">cache</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">getCacheKey</span>(),</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; html, expired &#125;)</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">authenticate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;正在验证身份...&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> challenge = crypto.<span class="title function_">getRandomValues</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">32</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> prfSalt = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">digest</span>(</span><br><span class="line">        <span class="string">&quot;SHA-256&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">prfSalt</span>)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> assertion = <span class="keyword">await</span> navigator.<span class="property">credentials</span>.<span class="title function_">get</span>(&#123;</span><br><span class="line">        <span class="attr">publicKey</span>: &#123;</span><br><span class="line">          challenge,</span><br><span class="line">          <span class="attr">rpId</span>: <span class="variable language_">this</span>.<span class="property">rpId</span>,</span><br><span class="line">          <span class="attr">userVerification</span>: <span class="string">&quot;preferred&quot;</span>,</span><br><span class="line">          <span class="attr">timeout</span>: <span class="number">60000</span>,</span><br><span class="line">          <span class="attr">extensions</span>: &#123; <span class="attr">prf</span>: &#123; <span class="attr">eval</span>: &#123; <span class="attr">first</span>: prfSalt &#125; &#125; &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> prfResults = assertion.<span class="title function_">getClientExtensionResults</span>().<span class="property">prf</span>;</span><br><span class="line">      <span class="keyword">if</span> (!prfResults?.<span class="property">results</span>?.<span class="property">first</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;PRF 扩展不可用&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> wrappingKey = prfResults.<span class="property">results</span>.<span class="property">first</span>;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;验证成功，正在解密...&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">unwrapAndDecrypt</span>(wrappingKey), <span class="number">300</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.<span class="property">name</span> === <span class="string">&quot;NotAllowedError&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;验证被拒绝&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">name</span> === <span class="string">&quot;InvalidStateError&quot;</span> || e.<span class="property">name</span> === <span class="string">&quot;NotFoundError&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;未注册的通行密钥&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">`验证失败: <span class="subst">$&#123;e.message&#125;</span>`</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">derivePBKDF2Key</span>(<span class="params">password, salt, iterations = PBKDF2_ITERATIONS</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> passwordBuffer = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(password);</span><br><span class="line">    <span class="keyword">const</span> saltBuffer = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(salt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> baseKey = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">importKey</span>(</span><br><span class="line">      <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">      passwordBuffer,</span><br><span class="line">      <span class="string">&quot;PBKDF2&quot;</span>,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      [<span class="string">&quot;deriveBits&quot;</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> derivedBits = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">deriveBits</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;PBKDF2&quot;</span>,</span><br><span class="line">        <span class="attr">salt</span>: saltBuffer,</span><br><span class="line">        <span class="attr">iterations</span>: iterations,</span><br><span class="line">        <span class="attr">hash</span>: <span class="string">&quot;SHA-256&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      baseKey,</span><br><span class="line">      <span class="number">256</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> derivedBits;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">decryptWithPassword</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> passwordInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;password-input&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> password = passwordInput?.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;未输入密码&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;正在解密...&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> passwordWrapped = <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">wrappedKeys</span>.<span class="title function_">find</span>(</span><br><span class="line">        <span class="function">(<span class="params">k</span>) =&gt;</span> k.<span class="property">type</span> === <span class="string">&quot;password&quot;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (!passwordWrapped) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;不支持密码认证&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> wrappingKey = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">derivePBKDF2Key</span>(</span><br><span class="line">        password,</span><br><span class="line">        passwordWrapped.<span class="property">salt</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">unwrapAndDecrypt</span>(wrappingKey, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">`解密失败: <span class="subst">$&#123;e.message&#125;</span>`</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">combineWithAuthTag</span>(<span class="params">data, authTag</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> combined = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(data.<span class="property">byteLength</span> + authTag.<span class="property">byteLength</span>);</span><br><span class="line">    combined.<span class="title function_">set</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(data), <span class="number">0</span>);</span><br><span class="line">    combined.<span class="title function_">set</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(authTag), data.<span class="property">byteLength</span>);</span><br><span class="line">    <span class="keyword">return</span> combined;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">unwrapAndDecrypt</span>(<span class="params">wrappingKey, type = <span class="string">&quot;fido2&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> wrapKeyBuffer = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">importKey</span>(</span><br><span class="line">        <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">        wrappingKey,</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&quot;AES-GCM&quot;</span> &#125;,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        [<span class="string">&quot;decrypt&quot;</span>]</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> targetKeys = <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">wrappedKeys</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> k.<span class="property">type</span> === type);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> cek = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> wrapped <span class="keyword">of</span> targetKeys) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> encCEK = <span class="variable language_">this</span>.<span class="title function_">b64ToAB</span>(wrapped.<span class="property">encryptedCEK</span>);</span><br><span class="line">          <span class="keyword">const</span> wrapIV = <span class="variable language_">this</span>.<span class="title function_">b64ToAB</span>(wrapped.<span class="property">iv</span>);</span><br><span class="line">          <span class="keyword">const</span> wrapAuthTag = <span class="variable language_">this</span>.<span class="title function_">b64ToAB</span>(wrapped.<span class="property">authTag</span>);</span><br><span class="line">          <span class="keyword">const</span> wrappedCEK = <span class="variable language_">this</span>.<span class="title function_">combineWithAuthTag</span>(encCEK, wrapAuthTag);</span><br><span class="line"></span><br><span class="line">          cek = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">decrypt</span>(</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">&quot;AES-GCM&quot;</span>, <span class="attr">iv</span>: wrapIV, <span class="attr">tagLength</span>: <span class="number">128</span> &#125;,</span><br><span class="line">            wrapKeyBuffer,</span><br><span class="line">            wrappedCEK</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!cek)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(type === <span class="string">&quot;password&quot;</span> ? <span class="string">&quot;密码错误&quot;</span> : <span class="string">&quot;通行密钥无权限&quot;</span>);</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">decryptContent</span>(cek);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">`解密失败: <span class="subst">$&#123;e.message&#125;</span>`</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">decryptContent</span>(<span class="params">decryptionKey</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">&quot;正在解密...&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> ciphertext = <span class="variable language_">this</span>.<span class="title function_">b64ToAB</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">ciphertext</span>);</span><br><span class="line">      <span class="keyword">const</span> iv = <span class="variable language_">this</span>.<span class="title function_">b64ToAB</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">iv</span>);</span><br><span class="line">      <span class="keyword">const</span> authTag = <span class="variable language_">this</span>.<span class="title function_">b64ToAB</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">authTag</span>);</span><br><span class="line">      <span class="keyword">const</span> encData = <span class="variable language_">this</span>.<span class="title function_">combineWithAuthTag</span>(ciphertext, authTag);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> key = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">importKey</span>(</span><br><span class="line">        <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">        decryptionKey,</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&quot;AES-GCM&quot;</span> &#125;,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        [<span class="string">&quot;decrypt&quot;</span>]</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> decrypted = <span class="keyword">await</span> crypto.<span class="property">subtle</span>.<span class="title function_">decrypt</span>(</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&quot;AES-GCM&quot;</span>, iv, <span class="attr">tagLength</span>: <span class="number">128</span> &#125;,</span><br><span class="line">        key,</span><br><span class="line">        encData</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> html = <span class="keyword">new</span> <span class="title class_">TextDecoder</span>().<span class="title function_">decode</span>(decrypted);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">saveCache</span>(html);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">render</span>(html);</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">hideStatus</span>(), <span class="number">2000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">showStatus</span>(<span class="string">`解密失败: <span class="subst">$&#123;e.message&#125;</span>`</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">executeScripts</span>(<span class="params">container</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> scripts = container.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    scripts.<span class="title function_">forEach</span>(<span class="function">(<span class="params">oldScript</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> newScript = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">      <span class="title class_">Array</span>.<span class="title function_">from</span>(oldScript.<span class="property">attributes</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">attr</span>) =&gt;</span> &#123;</span><br><span class="line">        newScript.<span class="title function_">setAttribute</span>(attr.<span class="property">name</span>, attr.<span class="property">value</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">      newScript.<span class="property">textContent</span> = oldScript.<span class="property">textContent</span>;</span><br><span class="line">      oldScript.<span class="property">parentNode</span>.<span class="title function_">replaceChild</span>(newScript, oldScript);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params">html</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> content = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;decrypted-content&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> notice = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;.encrypted-post-notice&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!content || !notice) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    notice.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">    content.<span class="property">innerHTML</span> = html;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">executeScripts</span>(content);</span><br><span class="line">    content.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;block&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateLockIconState</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderRefresh</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateLockIconState</span>(<span class="params">isDecrypted</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> abbr = <span class="variable language_">this</span>.<span class="property">getCacheKey</span>?.() || <span class="variable language_">this</span>.<span class="property">data</span>?.<span class="property">abbrlink</span>;</span><br><span class="line">    <span class="keyword">if</span> (!abbr) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> lockIcon = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`lock-icon-<span class="subst">$&#123;abbr&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (!lockIcon) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isDecrypted) &#123;</span><br><span class="line">      lockIcon.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;decrypted&quot;</span>);</span><br><span class="line">      lockIcon.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;fa-lock&quot;</span>);</span><br><span class="line">      lockIcon.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;fa-unlock&quot;</span>);</span><br><span class="line">      lockIcon.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&quot;pointer&quot;</span>;</span><br><span class="line">      lockIcon.<span class="title function_">addEventListener</span>(</span><br><span class="line">        <span class="string">&quot;click&quot;</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(abbr);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line">          location.<span class="title function_">reload</span>();</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      lockIcon.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;decrypted&quot;</span>);</span><br><span class="line">      lockIcon.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;fa-unlock&quot;</span>);</span><br><span class="line">      lockIcon.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;fa-lock&quot;</span>);</span><br><span class="line">      lockIcon.<span class="property">style</span>.<span class="property">cursor</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">showStatus</span>(<span class="params">msg, type = <span class="string">&quot;info&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;verification-status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!el) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">const</span> icons = &#123;</span><br><span class="line">      <span class="attr">info</span>: <span class="string">&quot;fa-info-circle&quot;</span>,</span><br><span class="line">      <span class="attr">success</span>: <span class="string">&quot;fa-check-circle&quot;</span>,</span><br><span class="line">      <span class="attr">error</span>: <span class="string">&quot;fa-times-circle&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    el.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">    el.<span class="property">className</span> = <span class="string">`verification-status <span class="subst">$&#123;type&#125;</span>`</span>;</span><br><span class="line">    el.<span class="property">innerHTML</span> = <span class="string">`&lt;i class=&quot;fa <span class="subst">$&#123;icons[type]&#125;</span>&quot;&gt;&lt;/i&gt; <span class="subst">$&#123;msg&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">hideStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;verification-status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (el) el.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">rebuildTOC</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> content = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;decrypted-content&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> tocWrap = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;.post-toc-wrap&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> sidebar = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;.sidebar-inner&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> utils = <span class="variable language_">window</span>.<span class="property">NexT</span>?.<span class="property">utils</span>;</span><br><span class="line">      <span class="keyword">if</span> (!content || !tocWrap) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> headings = content.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;h1,h2,h3,h4,h5,h6&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">ensureToc</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">        tocWrap.<span class="title function_">querySelector</span>(<span class="string">&quot;.post-toc&quot;</span>) ||</span><br><span class="line">        (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">          el.<span class="property">className</span> = <span class="string">&quot;post-toc animated&quot;</span>;</span><br><span class="line">          tocWrap.<span class="title function_">appendChild</span>(el);</span><br><span class="line">          <span class="keyword">return</span> el;</span><br><span class="line">        &#125;)();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!headings.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> exist = tocWrap.<span class="title function_">querySelector</span>(<span class="string">&quot;.post-toc&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (exist) exist.<span class="property">innerHTML</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        sidebar?.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;sidebar-nav-active&quot;</span>, <span class="string">&quot;sidebar-toc-active&quot;</span>);</span><br><span class="line">        sidebar?.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;sidebar-overview-active&quot;</span>);</span><br><span class="line">        utils?.<span class="property">registerSidebarTOC</span>?.();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; roots &#125; = <span class="title class_">Array</span>.<span class="title function_">from</span>(headings).<span class="title function_">reduce</span>(</span><br><span class="line">        <span class="function">(<span class="params">acc, h, i</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!h.<span class="property">id</span>) h.<span class="property">id</span> = <span class="string">`heading-<span class="subst">$&#123;i&#125;</span>`</span>;</span><br><span class="line">          <span class="keyword">const</span> level = <span class="built_in">parseInt</span>(h.<span class="property">tagName</span>[<span class="number">1</span>], <span class="number">10</span>);</span><br><span class="line">          <span class="keyword">const</span> node = &#123;</span><br><span class="line">            level,</span><br><span class="line">            <span class="attr">id</span>: h.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">text</span>: h.<span class="property">textContent</span>.<span class="title function_">trim</span>(),</span><br><span class="line">            <span class="attr">children</span>: [],</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="keyword">while</span> (acc.<span class="property">stack</span>.<span class="property">length</span> &amp;&amp; acc.<span class="property">stack</span>.<span class="title function_">at</span>(-<span class="number">1</span>).<span class="property">level</span> &gt;= level)</span><br><span class="line">            acc.<span class="property">stack</span>.<span class="title function_">pop</span>();</span><br><span class="line">          (acc.<span class="property">stack</span>.<span class="property">length</span> ? acc.<span class="property">stack</span>.<span class="title function_">at</span>(-<span class="number">1</span>).<span class="property">children</span> : acc.<span class="property">roots</span>).<span class="title function_">push</span>(node);</span><br><span class="line">          acc.<span class="property">stack</span>.<span class="title function_">push</span>(node);</span><br><span class="line">          <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="attr">roots</span>: [], <span class="attr">stack</span>: [] &#125;</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">nodes, depth = <span class="number">1</span></span>) =&gt;</span><br><span class="line">        nodes</span><br><span class="line">          .<span class="title function_">map</span>(<span class="function">(<span class="params">n</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> link = <span class="string">`&lt;a class=&quot;nav-link&quot; href=&quot;#<span class="subst">$&#123;n.id&#125;</span>&quot;&gt;&lt;span class=&quot;nav-text&quot;&gt;<span class="subst">$&#123;n.text&#125;</span>&lt;/span&gt;&lt;/a&gt;`</span>;</span><br><span class="line">            <span class="keyword">const</span> kids = n.<span class="property">children</span>.<span class="property">length</span></span><br><span class="line">              ? <span class="string">`&lt;ol class=&quot;nav-child&quot;&gt;<span class="subst">$&#123;render(n.children, depth + <span class="number">1</span>)&#125;</span>&lt;/ol&gt;`</span></span><br><span class="line">              : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`&lt;li class=&quot;nav-item nav-level-<span class="subst">$&#123;depth&#125;</span>&quot;&gt;<span class="subst">$&#123;link&#125;</span><span class="subst">$&#123;kids&#125;</span>&lt;/li&gt;`</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> toc = <span class="title function_">ensureToc</span>();</span><br><span class="line">      toc.<span class="property">innerHTML</span> = <span class="string">`&lt;ol class=&quot;nav&quot;&gt;<span class="subst">$&#123;render(roots)&#125;</span>&lt;/ol&gt;`</span>;</span><br><span class="line"></span><br><span class="line">      sidebar?.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&quot;sidebar-nav-active&quot;</span>, <span class="string">&quot;sidebar-toc-active&quot;</span>);</span><br><span class="line">      sidebar?.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&quot;sidebar-overview-active&quot;</span>);</span><br><span class="line">      utils?.<span class="property">registerSidebarTOC</span>?.();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`TOC 重建失败: <span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">renderRefresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">rebuildTOC</span>();</span><br><span class="line">    <span class="title class_">NexT</span>?.<span class="property">boot</span>?.<span class="property">refresh</span>?.();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">b64ToAB</span>(<span class="params">b64</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> str = <span class="title function_">atob</span>(b64);</span><br><span class="line">    <span class="keyword">const</span> bytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(str.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) bytes[i] = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">    <span class="keyword">return</span> bytes.<span class="property">buffer</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> decryptor = <span class="keyword">new</span> <span class="title class_">Decryptor</span>();</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;.encrypted-post-container&quot;</span>)) decryptor.<span class="title function_">init</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="解密流程-2"><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.encrypted-post-container</span></span><br><span class="line">  <span class="attribute">min-height</span>: <span class="number">100px</span></span><br><span class="line"></span><br><span class="line">.encrypted-post-notice</span><br><span class="line">  text-align: center</span><br><span class="line">  padding: <span class="number">40px</span> <span class="number">20px</span></span><br><span class="line">  background: transparent</span><br><span class="line">  border-radius: <span class="number">12px</span></span><br><span class="line">  margin: <span class="number">20px</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">.decrypt-methods</span><br><span class="line">  display: flex</span><br><span class="line">  flex-direction: column</span><br><span class="line">  align-items: center</span><br><span class="line">  gap: <span class="number">15px</span></span><br><span class="line">  max-width: <span class="number">280px</span></span><br><span class="line">  margin: <span class="number">0</span> auto</span><br><span class="line"></span><br><span class="line">.decrypt-btn</span><br><span class="line">  width: <span class="number">100%</span></span><br><span class="line">  background: <span class="number">#3b8fc7</span></span><br><span class="line">  color: white</span><br><span class="line">  border: none</span><br><span class="line">  padding: <span class="number">15px</span> <span class="number">40px</span></span><br><span class="line">  font-size: <span class="number">16px</span></span><br><span class="line">  border-radius: <span class="number">30px</span></span><br><span class="line">  cursor: pointer</span><br><span class="line">  transition: all .<span class="number">3s</span> ease</span><br><span class="line">  box-shadow: <span class="number">0</span> <span class="number">4px</span> <span class="number">15px</span> <span class="built_in">rgba</span>(<span class="number">59</span>,<span class="number">143</span>,<span class="number">199</span>,.<span class="number">4</span>)</span><br><span class="line">  text-align: center</span><br><span class="line"></span><br><span class="line">.decrypt-btn:hover</span><br><span class="line">  transform: <span class="built_in">translateY</span>(-<span class="number">2px</span>)</span><br><span class="line">  box-shadow: <span class="number">0</span> <span class="number">6px</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">59</span>,<span class="number">143</span>,<span class="number">199</span>,.<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">.decrypt-btn:active</span><br><span class="line">  transform: <span class="built_in">translateY</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">.decrypt-btn:disabled</span><br><span class="line">  opacity: <span class="number">0.5</span></span><br><span class="line">  cursor: not-allowed</span><br><span class="line">  transform: none</span><br><span class="line"></span><br><span class="line">.decrypt-btn:disabled:hover</span><br><span class="line">  transform: none</span><br><span class="line">  box-shadow: <span class="number">0</span> <span class="number">4px</span> <span class="number">15px</span> <span class="built_in">rgba</span>(<span class="number">59</span>,<span class="number">143</span>,<span class="number">199</span>,.<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">.decrypt-btn i</span><br><span class="line">  margin-right: <span class="number">8px</span></span><br><span class="line"></span><br><span class="line">.password-decrypt-group</span><br><span class="line">  width: <span class="number">100%</span></span><br><span class="line">  display: flex</span><br><span class="line">  flex-direction: column</span><br><span class="line">  gap: <span class="number">10px</span></span><br><span class="line"></span><br><span class="line">.password-input-group</span><br><span class="line">  width: <span class="number">100%</span></span><br><span class="line">  display: flex</span><br><span class="line">  flex-direction: column</span><br><span class="line">  gap: <span class="number">10px</span></span><br><span class="line">  animation: fadeIn .<span class="number">3s</span> ease-in</span><br><span class="line"></span><br><span class="line">.password-input</span><br><span class="line">  width: <span class="number">100%</span></span><br><span class="line">  padding: <span class="number">12px</span> <span class="number">20px</span></span><br><span class="line">  font-size: <span class="number">15px</span></span><br><span class="line">  border: <span class="number">2px</span> solid <span class="number">#e0e0e0</span></span><br><span class="line">  border-radius: <span class="number">25px</span></span><br><span class="line">  outline: none</span><br><span class="line">  transition: border-color .<span class="number">3s</span> ease</span><br><span class="line">  box-sizing: border-box</span><br><span class="line"></span><br><span class="line">.password-input:focus</span><br><span class="line">  border-color: <span class="number">#3b8fc7</span></span><br><span class="line"></span><br><span class="line">.password-hint</span><br><span class="line">  font-size: <span class="number">13px</span></span><br><span class="line">  color: <span class="number">#666</span></span><br><span class="line">  text-align: center</span><br><span class="line">  margin-top: <span class="number">8px</span></span><br><span class="line">  padding: <span class="number">8px</span> <span class="number">12px</span></span><br><span class="line">  background: <span class="number">#f8f9fa</span></span><br><span class="line">  border-radius: <span class="number">6px</span></span><br><span class="line">  border: <span class="number">1px</span> solid <span class="number">#e9ecef</span></span><br><span class="line"></span><br><span class="line">.verification-status</span><br><span class="line">  margin-top: <span class="number">20px</span></span><br><span class="line">  padding: <span class="number">12px</span> <span class="number">20px</span></span><br><span class="line">  border-radius: <span class="number">8px</span></span><br><span class="line">  font-size: <span class="number">14px</span></span><br><span class="line">  display: none</span><br><span class="line">  max-width: <span class="number">300px</span></span><br><span class="line">  margin-left: auto</span><br><span class="line">  margin-right: auto</span><br><span class="line"></span><br><span class="line">.verification-status.info</span><br><span class="line">  background: <span class="number">#e7f3ff</span></span><br><span class="line">  color: <span class="number">#0066cc</span></span><br><span class="line">  border: <span class="number">1px</span> solid <span class="number">#b3d9ff</span></span><br><span class="line"></span><br><span class="line">.verification-status.success</span><br><span class="line">  background: <span class="number">#e6f9e6</span></span><br><span class="line">  color: <span class="number">#00aa00</span></span><br><span class="line">  border: <span class="number">1px</span> solid <span class="number">#b3e6b3</span></span><br><span class="line"></span><br><span class="line">.verification-status.error</span><br><span class="line">  background: <span class="number">#ffe6e6</span></span><br><span class="line">  color: <span class="number">#cc0000</span></span><br><span class="line">  border: <span class="number">1px</span> solid <span class="number">#ffb3b3</span></span><br><span class="line"></span><br><span class="line">.verification-status i</span><br><span class="line">  margin-right: <span class="number">8px</span></span><br><span class="line"></span><br><span class="line">.decrypted-content</span><br><span class="line">  animation: fadeIn .<span class="number">5s</span> ease-in</span><br><span class="line"></span><br><span class="line">@keyframes fadeIn</span><br><span class="line">  from</span><br><span class="line">    opacity: <span class="number">0</span></span><br><span class="line">    transform: <span class="built_in">translateY</span>(<span class="number">10px</span>)</span><br><span class="line">  to</span><br><span class="line">    opacity: <span class="number">1</span></span><br><span class="line">    transform: <span class="built_in">translateY</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">.encrypted-post-preview</span><br><span class="line">  padding: <span class="number">20px</span></span><br><span class="line">  background: <span class="number">#f8f9fa</span></span><br><span class="line">  border-radius: <span class="number">4px</span></span><br><span class="line">  color: <span class="number">#666</span></span><br><span class="line"></span><br><span class="line">.encrypted-status</span><br><span class="line">  display: flex</span><br><span class="line">  align-items: center</span><br><span class="line">  justify-content: center</span><br><span class="line">  gap: <span class="number">8px</span></span><br><span class="line">  font-size: <span class="number">15px</span></span><br><span class="line">  color: <span class="number">#888</span></span><br><span class="line"></span><br><span class="line">.encrypted-status i</span><br><span class="line">  color: <span class="number">#667eea</span></span><br><span class="line">  font-size: <span class="number">16px</span></span><br><span class="line"></span><br><span class="line">.encrypted-decrypted-preview</span><br><span class="line">  animation: fadeIn .<span class="number">5s</span> ease-in</span><br><span class="line">  line-height: <span class="number">1.8</span></span><br><span class="line">  color: <span class="number">#333</span></span><br><span class="line"></span><br><span class="line">.encrypted-lock-icon-index</span><br><span class="line">  color: <span class="number">#e74c3c</span></span><br><span class="line">  margin-right: <span class="number">8px</span></span><br><span class="line">  font-size: <span class="number">18px</span></span><br><span class="line">  vertical-align: baseline</span><br><span class="line">  position: relative</span><br><span class="line">  top: -<span class="number">1px</span></span><br><span class="line">  transition: color <span class="number">0.3s</span> ease</span><br><span class="line"></span><br><span class="line">.encrypted-lock-icon-index.decrypted</span><br><span class="line">  color: <span class="number">#27ae60</span></span><br><span class="line"></span><br><span class="line">.encrypted-lock-icon-small</span><br><span class="line">  color: <span class="number">#e74c3c</span></span><br><span class="line">  margin-right: <span class="number">6px</span></span><br><span class="line">  font-size: <span class="number">10px</span></span><br><span class="line">  vertical-align: baseline</span><br><span class="line">  position: relative</span><br><span class="line">  top: -<span class="number">1px</span></span><br><span class="line"></span><br><span class="line">.encrypted-lock-icon-small.decrypted</span><br><span class="line">    color: <span class="number">#27ae60</span></span><br><span class="line"></span><br><span class="line">@media (prefers-color-scheme: dark)</span><br><span class="line">  .encrypted-post-notice</span><br><span class="line">    background: transparent</span><br><span class="line"></span><br><span class="line">  .password-input</span><br><span class="line">    background: <span class="number">#374151</span></span><br><span class="line">    color: <span class="number">#f3f4f6</span></span><br><span class="line">    border-color: <span class="number">#4b5563</span></span><br><span class="line"></span><br><span class="line">  .password-input:focus</span><br><span class="line">    border-color: <span class="number">#3b8fc7</span></span><br><span class="line"></span><br><span class="line">  .encrypted-post-preview</span><br><span class="line">    background: <span class="number">#2d3748</span></span><br><span class="line">    color: <span class="number">#a0aec0</span></span><br><span class="line">  </span><br><span class="line">  .encrypted-status</span><br><span class="line">    color: <span class="number">#9ca3af</span></span><br><span class="line">  </span><br><span class="line">  .encrypted-status i</span><br><span class="line">    color: <span class="number">#9fa8da</span></span><br><span class="line">  </span><br><span class="line">  .encrypted-decrypted-preview</span><br><span class="line">    color: <span class="number">#e5e7eb</span></span><br><span class="line">  </span><br><span class="line">  .encrypted-lock-icon-index</span><br><span class="line">    color: <span class="number">#ff6b6b</span></span><br><span class="line">  </span><br><span class="line">  .encrypted-lock-icon-index.decrypted</span><br><span class="line">    color: <span class="number">#2ecc71</span></span><br><span class="line"></span><br><span class="line">  .encrypted-lock-icon-small</span><br><span class="line">    color: <span class="number">#ff6b6b</span></span><br><span class="line"></span><br><span class="line">  .encrypted-lock-icon-small.decrypted</span><br><span class="line">    color: <span class="number">#2ecc71</span></span><br><span class="line"></span><br><span class="line">  .password-hint</span><br><span class="line">    background: <span class="number">#374151</span></span><br><span class="line">    color: <span class="number">#d1d5db</span></span><br><span class="line">    border-color: <span class="number">#4b5563</span></span><br></pre></td></tr></table></figure></div></div></div><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ul><li><code>encrypted</code>: 可选<ul><li><code>true</code> 加密该文章</li><li><code>false</code> 不加密该文章</li></ul></li><li><code>password</code>: 可选</li><li><code>password_hint</code>: 可选</li></ul><div class="note info"><ul><li><code>encrypted</code> 控制文章是否加密，使用已注册的安全密钥可以解密所有加密文章。</li><li><code>password</code> 增加密码解密的选项，可以每个文章不同。安全密钥或者密码使用其一均可以解密。</li><li><code>password_hint</code> 仅当设置了密码有效，在密码输入框下展示密码提示。</li></ul></div><p>一个典型的文章 Markdown 头内容如下</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">文章标题</span></span><br><span class="line"><span class="attr">abbrlink:</span>  <span class="number">12345678</span></span><br><span class="line"><span class="attr">encrypted:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">password_hint:</span> <span class="string">密码提示内容</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><h2 id="七零八碎"><a href="#七零八碎" class="headerlink" title="七零八碎"></a>七零八碎</h2><h3 id="修补-head-unique-njk"><a href="#修补-head-unique-njk" class="headerlink" title="修补 head-unique.njk"></a>修补 head-unique.njk</h3><p>因为使用 <code>generate</code> 生成文章 HTML 的时候会生成一些 <code>meta</code> 标签数据，其中会包括 <code>description</code> 信息，如果文章头部没有 <code>description</code> 字段则会使用正文的部分内容作为 <code>meta.description</code> 这样会导致文章部分内容泄露到 HTML 中，所以这里修补一下这里的逻辑，如果是加密文章则不生成 <code>meta</code> 标签</p><ul><li><code>./themes/next/layout/_partials/head/head-unique.njk</code> (修改)</li></ul><div class="tabs" id="head-unique.njk"><ul class="nav-tabs"><li class="tab active"><a href="#head-unique.njk-1"><i class="fa fa-code"></i>./themes/next/layout/_partials/head/head-unique.njk</a></li></ul><div class="tab-content"><div class="tab-pane active" id="head-unique.njk-1"><figure class="highlight jinja"><table><tr><td class="code"><pre><span class="line"><span class="comment">&#123;# 判断文章是否是是加密的，如果不是则生成对应的 meta 标签 #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> not page.encrypted %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; open_graph() &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;# https://github.com/theme-next/hexo-theme-next/issues/866 #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name">set</span> canonical = url | replace(r/index\.html$/, &#x27;&#x27;) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> not config.permalink.endsWith(&#x27;.html&#x27;) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name">set</span> canonical = canonical | replace(r/\.html$/, &#x27;&#x27;) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;canonical&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; canonical &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;# Exports some front-matter variables to Front-End #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;# https://hexo.io/docs/variables.html #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; next_data(&#x27;page&#x27;, next_config_unique()) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; next_data(&#x27;calendar&#x27;,</span></span><br><span class="line"><span class="template-variable">  theme.calendar if page.type === &#x27;schedule&#x27; else &#x27;&#x27;)</span></span><br><span class="line"><span class="template-variable">&#125;&#125;</span></span><br></pre></td></tr></table></figure></div></div></div><h3 id="修补-post-njk"><a href="#修补-post-njk" class="headerlink" title="修补 post.njk"></a>修补 post.njk</h3><p>加密后的文章在首页预览的时候会显示 <code>文章已加密</code> 的提示字样。同时如果文章已经解密，则正常展示预览部分 (即 <code>&lt;!-- more --&gt;</code> 之前的内容)</p><p>同时在首页文章标题前面增加一把锁图标，未解密时是红色锁定图标，已解密变为绿色开锁图标</p><p>并且，在文章内标题前方也增加所得图标。同时点击解密后的绿色开锁图标文章会立刻变为加密状态。</p><ul><li><code>./themes/next/layout/_macro/post.njk</code> (修改)</li></ul><div class="tabs" id="post.njk"><ul class="nav-tabs"><li class="tab active"><a href="#post.njk-1"><i class="fa fa-code"></i>./themes/next/layout/_macro/post.njk</a></li></ul><div class="tab-content"><div class="tab-pane active" id="post.njk-1"><figure class="highlight jinja"><table><tr><td class="code"><pre><span class="line"><span class="comment">&#123;# POST BLOCK 部分的修改 #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;##################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;### POST BLOCK ###&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;##################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.header !== false %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;post-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &lt;</span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> is_index %&#125;</span><span class="language-xml">h2</span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="language-xml">h1</span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"> class=&quot;post-title</span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> post.direction and post.direction.toLowerCase() === &#x27;rtl&#x27; %&#125;</span><span class="language-xml"> rtl</span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml">&quot; itemprop=&quot;name headline&quot;&gt;</span></span><br><span class="line"><span class="language-xml">    </span><span class="comment">&#123;# Link posts #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.link %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.sticky &gt; 0 %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-sticky-flag&quot;</span> <span class="attr">title</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; __(&#x27;post.sticky&#x27;) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-thumbtack&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name">set</span> postTitleIcon = &#x27;&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name">set</span> postText = post.title or post.link %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123;- next_url(post.link, postText + postTitleIcon, &#123;class: &#x27;post-title-link post-title-link-external&#x27;, itemprop: &#x27;url&#x27;&#125;) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">elif</span></span> is_index %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.sticky &gt; 0 %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-sticky-flag&quot;</span> <span class="attr">title</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; __(&#x27;post.sticky&#x27;) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-thumbtack&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="comment">&#123;########################################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="comment">&#123;############# 首页增加锁图标 #############&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="comment">&#123;########################################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.encrypted %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-lock encrypted-lock-icon-index&quot;</span> <span class="attr">id</span>=<span class="string">&quot;lock-icon-</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123;- next_url(post.path, post.title or __(&#x27;post.untitled&#x27;), &#123;class: &#x27;post-title-link&#x27;, itemprop: &#x27;url&#x27;&#125;) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">else</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="comment">&#123;########################################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="comment">&#123;########## 文章内标题前增加锁图标 ##########&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="comment">&#123;########################################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.encrypted %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-lock encrypted-lock-icon-index&quot;</span> <span class="attr">id</span>=<span class="string">&quot;lock-icon-</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123;- post.title &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123;- post_edit(post.source) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  &lt;/</span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> is_index %&#125;</span><span class="language-xml">h2</span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="language-xml">h1</span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml">&gt;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123; partial(&#x27;_partials/post/post-meta.njk&#x27;) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.description and (not theme.excerpt_description or not is_index) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-description&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; post.description &#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;# POST BODY 部分的修改 #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;#################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;### POST BODY ###&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;#################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-body</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> post.direction and post.direction.toLowerCase() === &#x27;rtl&#x27; %&#125;</span><span class="language-xml"><span class="tag"><span class="string"> rtl</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;articleBody&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> is_index %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.encrypted %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;encrypted-post-preview&quot;</span> <span class="attr">id</span>=<span class="string">&quot;encrypted-preview-</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">data-abbrlink</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;encrypted-status&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-shield-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 文章已加密</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;encrypted-decrypted-preview&quot;</span> <span class="attr">id</span>=<span class="string">&quot;decrypted-preview-</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display:none;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!--noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> theme.read_more_btn %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-button&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; url_for(post.path) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span><span class="template-variable">&#123;&#123; __(&#x27;post.read_more&#x27;) &#125;&#125;</span><span class="language-xml"> <span class="symbol">&amp;raquo;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!--/noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="keyword">const</span> cacheKey = <span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml">&quot;;</span></span><br><span class="line"><span class="language-xml">          try &#123;</span></span><br><span class="line"><span class="language-xml">            const cached = localStorage.getItem(cacheKey);</span></span><br><span class="line"><span class="language-xml">            if (!cached) return;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            const &#123; html, expired &#125; = JSON.parse(cached);</span></span><br><span class="line"><span class="language-xml">            if (Date.now() &gt;= expired) &#123;</span></span><br><span class="line"><span class="language-xml">              localStorage.removeItem(cacheKey);</span></span><br><span class="line"><span class="language-xml">              return;</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            const tempDiv = document.createElement(&quot;div&quot;);</span></span><br><span class="line"><span class="language-xml">            tempDiv.innerHTML = html;</span></span><br><span class="line"><span class="language-xml">            const moreElement = tempDiv.querySelector(&quot;#more&quot;);</span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            let preview = &quot;&quot;;</span></span><br><span class="line"><span class="language-xml">            if (moreElement) &#123;</span></span><br><span class="line"><span class="language-xml">              const range = document.createRange();</span></span><br><span class="line"><span class="language-xml">              range.setStartBefore(tempDiv.firstChild);</span></span><br><span class="line"><span class="language-xml">              range.setEndBefore(moreElement);</span></span><br><span class="line"><span class="language-xml">              preview = range.cloneContents().textContent.trim();</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            if (!preview) &#123;</span></span><br><span class="line"><span class="language-xml">              const text = tempDiv.textContent.trim();</span></span><br><span class="line"><span class="language-xml">              preview = text ? text.substring(0, 200) + (text.length &gt; 200 ? &quot;...&quot; : &quot;&quot;) : &quot;暂无预览&quot;;</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            const previewEl = document.getElementById(&quot;decrypted-preview-</span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml">&quot;);</span></span><br><span class="line"><span class="language-xml">            const encryptedEl = document.getElementById(&quot;encrypted-preview-</span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml">&quot;);</span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            if (previewEl) &#123;</span></span><br><span class="line"><span class="language-xml">              previewEl.textContent = preview;</span></span><br><span class="line"><span class="language-xml">              previewEl.style.display = &quot;block&quot;;</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml">            if (encryptedEl) encryptedEl.style.display = &quot;none&quot;;</span></span><br><span class="line"><span class="language-xml">          &#125; catch (_) &#123;&#125;</span></span><br><span class="line"><span class="language-xml">        &#125;)();</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">elif</span></span> post.description and theme.excerpt_description %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123; post.description &#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!--noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> theme.read_more_btn %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-button&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; url_for(post.path) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span><span class="template-variable">&#123;&#123; __(&#x27;post.read_more&#x27;) &#125;&#125;</span><span class="language-xml"> <span class="symbol">&amp;raquo;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!--/noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">elif</span></span> post.excerpt %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123; post.excerpt &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!--noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> theme.read_more_btn %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-button&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; url_for(post.path) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">#more&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;contents&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span><span class="template-variable">&#123;&#123; __(&#x27;post.read_more&#x27;) &#125;&#125;</span><span class="language-xml"> <span class="symbol">&amp;raquo;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="comment">&lt;!--/noindex--&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123; post.content &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123; post.content | safe &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure></div></div></div><h3 id="修补-post-collapse-njk"><a href="#修补-post-collapse-njk" class="headerlink" title="修补 post-collapse.njk"></a>修补 post-collapse.njk</h3><p>除了首页增加锁图标，在归档页面增加同样的逻辑</p><ul><li><code>./themes/next/layout/_macro/post-collapse.njk</code> (修改)</li></ul><div class="tabs" id="post-collapse.njk"><ul class="nav-tabs"><li class="tab active"><a href="#post-collapse.njk-1"><i class="fa fa-code"></i>./themes/next/layout/_macro/post-collapse.njk</a></li></ul><div class="tab-content"><div class="tab-pane active" id="post-collapse.njk-1"><figure class="highlight jinja"><table><tr><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">macro</span> render(posts) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name">set</span> current_year = &#x27;1970&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">for</span></span> post <span class="keyword">in</span> posts.toArray() %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name">set</span> year = date(post.date, &#x27;YYYY&#x27;) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> year !== current_year %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;%- <span class="name">set</span> current_year = year %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;collection-year&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;collection-header&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; current_year &#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">article</span> <span class="attr">itemscope</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/Article&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;post-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">time</span> <span class="attr">itemprop</span>=<span class="string">&quot;dateCreated&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">datetime</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; moment(post.date).format() &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">content</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; date(post.date, config.date_format) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          </span><span class="template-variable">&#123;&#123; date(post.date, &#x27;MM-DD&#x27;) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">time</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;post-title&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.link %&#125;</span><span class="comment">&#123;# Link posts #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          </span><span class="template-tag">&#123;%- <span class="name">set</span> postTitleIcon = &#x27;&lt;i class=&quot;fa fa-external-link-alt&quot;&gt;&lt;/i&gt;&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          </span><span class="template-tag">&#123;%- <span class="name">set</span> postText = post.title or post.link %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          </span><span class="template-variable">&#123;&#123; next_url(post.link, postText + postTitleIcon, &#123;class: &#x27;post-title-link post-title-link-external&#x27;, itemprop: &#x27;url&#x27;&#125;) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;post-title-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; url_for(post.path) &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;url&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span><span class="comment">&#123;########################################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            </span><span class="comment">&#123;########### 增加对加密文章的判断 ##########&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            </span><span class="comment">&#123;########################################&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            </span><span class="template-tag">&#123;%- <span class="name"><span class="name">if</span></span> post.encrypted %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-lock encrypted-lock-icon-small&quot;</span> <span class="attr">id</span>=<span class="string">&quot;lock-icon-small-</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">              (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="keyword">const</span> cacheKey = <span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml">&quot;;</span></span><br><span class="line"><span class="language-xml">                try &#123;</span></span><br><span class="line"><span class="language-xml">                  const cached = localStorage.getItem(cacheKey);</span></span><br><span class="line"><span class="language-xml">                  if (!cached) return;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                  const &#123; expired &#125; = JSON.parse(cached);</span></span><br><span class="line"><span class="language-xml">                  if (Date.now() &gt;= expired) &#123;</span></span><br><span class="line"><span class="language-xml">                    localStorage.removeItem(cacheKey);</span></span><br><span class="line"><span class="language-xml">                    return;</span></span><br><span class="line"><span class="language-xml">                  &#125;</span></span><br><span class="line"><span class="language-xml">                    </span></span><br><span class="line"><span class="language-xml">                  const lockIcon = document.getElementById(&quot;lock-icon-small-</span><span class="template-variable">&#123;&#123; post.abbrlink &#125;&#125;</span><span class="language-xml">&quot;);</span></span><br><span class="line"><span class="language-xml">                  if (lockIcon) &#123;</span></span><br><span class="line"><span class="language-xml">                    lockIcon.classList.add(&#x27;decrypted&#x27;);</span></span><br><span class="line"><span class="language-xml">                    lockIcon.className = lockIcon.className.replace(&#x27;fa-lock&#x27;, &#x27;fa-unlock&#x27;);</span></span><br><span class="line"><span class="language-xml">                  &#125;</span></span><br><span class="line"><span class="language-xml">                &#125; catch (_) &#123;&#125;</span></span><br><span class="line"><span class="language-xml">              &#125;)();</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">itemprop</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; post.title or __(&#x27;post.untitled&#x27;) &#125;&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span><span class="template-tag">&#123;%- <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-variable">&#123;&#123; post_gallery(post.photos) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%- <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">endmacro</span> %&#125;</span></span><br></pre></td></tr></table></figure></div></div></div></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Zebedy</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://blog.zebedy.com/post/4de6100b.html" title="Hexo 使用通行密钥对文章加密">https://blog.zebedy.com/post/4de6100b.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpoLWhhbnM="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class="post-nav"><div class="post-nav-item"><a href="/post/19c1a188.html" rel="prev" title="测试加密文章"><i class="fa fa-chevron-left"></i> 测试加密文章</a></div><div class="post-nav-item"><a href="/post/7fa21f11.html" rel="next" title="2025 年骑刑台减脂计划">2025 年骑刑台减脂计划 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Zebedy</span></div><div class="vercount"><span class="post-meta-item" id="vercount_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="vercount_value_site_uv"></span> </span></span><span class="post-meta-item" id="vercount_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="vercount_value_site_pv"></span></span></span></div><span id="runtime_span"></span><script>var now=new Date;function show_runtime(){var n=new Date("Sat Feb 05 2022 08:00:00 GMT+0800 (中国标准时间)");now.setTime(now.getTime()+250),days=Math.floor((now-n)/1e3/60/60/24),hours=Math.floor((now-n)/1e3/60/60-24*days),1==String(hours).length&&(hours="0"+hours),minutes=Math.floor((now-n)/1e3/60-1440*days-60*hours),1==String(minutes).length&&(minutes="0"+minutes),seconds=Math.round((now-n)/1e3-86400*days-3600*hours-60*minutes),1==String(seconds).length&&(seconds="0"+seconds),document.getElementById("runtime_span").innerHTML=days+" 天 "+hours+" 小时 "+minutes+" 分 "+seconds+" 秒"}setInterval("show_runtime()",250)</script></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.8/dist/mermaid.min.js","integrity":"sha256-QmSAc2kIaUjleIJ46X7qPW2zrpCbXlMz3YIGgWpQ1Jo="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script async src="https://events.vercount.one/js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":false,"delay":true,"timeout":1000,"priority":true,"url":"https://blog.zebedy.com/post/4de6100b.html"}</script><script src="/js/third-party/quicklink.js"></script><script type="text/javascript" src="/js/crash-cheat.js"></script></body></html>