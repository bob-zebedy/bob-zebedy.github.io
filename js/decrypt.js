let PBKDF2_ITERATIONS=5e5;function getRPID(){var t=location.hostname;return"127.0.0.1"===t?"localhost":t}class Decryptor{constructor(){this.container=null,this.data=null,this.rpId=getRPID()}init(){var t;this.container=document.querySelector(".encrypted-post-container"),this.container&&(this.data={ciphertext:this.container.dataset.ciphertext,iv:this.container.dataset.iv,authTag:this.container.dataset.authTag,abbrlink:this.container.dataset.abbrlink,wrappedKeys:JSON.parse(this.container.dataset.wrappedKeys||"[]"),prfSalt:this.container.dataset.prfSalt,cache:parseInt(this.container.dataset.cache)||0,passwordHint:this.container.dataset.passwordHint||""},!this.checkCache())&&((t=document.getElementById("fido2-verify-btn"))&&(window.PublicKeyCredential?t.onclick=()=>this.authenticate():this.showStatus("浏览器不支持 FIDO2/WebAuthn","error")),(t=document.getElementById("show-password-btn"))&&(t.onclick=()=>this.showPasswordInput()),(t=document.getElementById("password-decrypt-btn"))&&(t.onclick=()=>this.decryptWithPassword()),t=document.getElementById("password-input"))&&t.addEventListener("keydown",t=>{"Enter"===t.key&&this.decryptWithPassword()})}getCacheKey(){return this.data.abbrlink}showPasswordInput(){var t=document.getElementById("show-password-btn"),e=document.getElementById("password-input-group"),a=document.getElementById("password-input");t&&(t.style.display="none"),e&&(e.style.display="flex"),this.data.passwordHint&&this.showPasswordHint(),a&&(a.focus(),a.addEventListener("input",()=>this.updatePasswordButtonState())),this.updatePasswordButtonState()}showPasswordHint(){var e=document.getElementById("password-input-group");if(e){let t=e.querySelector(".password-hint");t||((t=document.createElement("div")).className="password-hint",e.appendChild(t)),t.textContent=this.data.passwordHint}}updatePasswordButtonState(){var t=document.getElementById("password-input"),e=document.getElementById("password-decrypt-btn");t&&e&&(t=0<t.value.trim().length,e.disabled=!t,e.style.opacity=t?"1":"0.5",e.style.cursor=t?"pointer":"not-allowed")}checkCache(){if(!this.data.cache)return!1;try{var t=localStorage.getItem(this.getCacheKey());if(t){var{html:e,expired:a}=JSON.parse(t);if(Date.now()<a)return this.render(e),setTimeout(()=>this.hideStatus(),2e3),!0;localStorage.removeItem(this.getCacheKey())}return!1}catch(t){return!1}}saveCache(t){if(this.data.cache)try{var e=Date.now()+60*this.data.cache*1e3;localStorage.setItem(this.getCacheKey(),JSON.stringify({html:t,expired:e}))}catch(t){}}async authenticate(){this.showStatus("正在验证身份...","info");try{var e=crypto.getRandomValues(new Uint8Array(32)),a=await crypto.subtle.digest("SHA-256",(new TextEncoder).encode(this.data.prfSalt)),r=(await navigator.credentials.get({publicKey:{challenge:e,rpId:this.rpId,userVerification:"preferred",timeout:6e4,extensions:{prf:{eval:{first:a}}}}})).getClientExtensionResults().prf;if(!r?.results?.first)throw new Error("PRF 扩展不可用");let t=r.results.first;this.showStatus("验证成功，正在解密...","success"),setTimeout(()=>this.unwrapAndDecrypt(t),300)}catch(t){"NotAllowedError"===t.name?this.showStatus("验证被拒绝","error"):"InvalidStateError"===t.name||"NotFoundError"===t.name?this.showStatus("未注册的通行密钥","error"):this.showStatus("验证失败: "+t.message,"error")}}async derivePBKDF2Key(t,e,a=PBKDF2_ITERATIONS){t=(new TextEncoder).encode(t),e=(new TextEncoder).encode(e),t=await crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits"]);return await crypto.subtle.deriveBits({name:"PBKDF2",salt:e,iterations:a,hash:"SHA-256"},t,256)}async decryptWithPassword(){var t=document.getElementById("password-input")?.value.trim();if(t){this.showStatus("正在解密...","info");try{var e=this.data.wrappedKeys.find(t=>"password"===t.type);if(!e)throw new Error("不支持密码认证");var a=await this.derivePBKDF2Key(t,e.salt);await this.unwrapAndDecrypt(a,"password")}catch(t){this.showStatus("解密失败: "+t.message,"error")}}else this.showStatus("未输入密码","error")}combineWithAuthTag(t,e){var a=new Uint8Array(t.byteLength+e.byteLength);return a.set(new Uint8Array(t),0),a.set(new Uint8Array(e),t.byteLength),a}async unwrapAndDecrypt(e,a="fido2"){try{var r,s=await crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["decrypt"]),i=this.data.wrappedKeys.filter(t=>t.type===a);let t=null;for(r of i)try{var n=this.b64ToAB(r.encryptedCEK),o=this.b64ToAB(r.iv),c=this.b64ToAB(r.authTag),d=this.combineWithAuthTag(n,c);t=await crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:128},s,d);break}catch(t){}if(!t)throw new Error("password"===a?"密码错误":"通行密钥无权限");await this.decryptContent(t)}catch(t){this.showStatus("解密失败: "+t.message,"error")}}async decryptContent(t){try{this.showStatus("正在解密...","info");var e=this.b64ToAB(this.data.ciphertext),a=this.b64ToAB(this.data.iv),r=this.b64ToAB(this.data.authTag),s=this.combineWithAuthTag(e,r),i=await crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!1,["decrypt"]),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:a,tagLength:128},i,s),o=(new TextDecoder).decode(n);this.saveCache(o),this.render(o),setTimeout(()=>this.hideStatus(),2e3)}catch(t){this.showStatus("解密失败: "+t.message,"error")}}executeScripts(t){t.querySelectorAll("script").forEach(t=>{let e=document.createElement("script");Array.from(t.attributes).forEach(t=>{e.setAttribute(t.name,t.value)}),e.textContent=t.textContent,t.parentNode.replaceChild(e,t)})}render(t){var e=document.getElementById("decrypted-content"),a=document.querySelector(".encrypted-post-notice");e&&a&&(a.style.display="none",e.innerHTML=t,this.executeScripts(e),e.style.display="block",this.updateLockIconState(!0),this.renderRefresh())}updateLockIconState(t){let e=this.getCacheKey?.()||this.data?.abbrlink;var a;e&&(a=document.getElementById("lock-icon-"+e))&&(t?(a.classList.add("decrypted"),a.classList.remove("fa-lock"),a.classList.add("fa-unlock"),a.style.cursor="pointer",a.addEventListener("click",()=>{try{localStorage.removeItem(e)}catch(t){}location.reload()},{once:!0})):(a.classList.remove("decrypted"),a.classList.remove("fa-unlock"),a.classList.add("fa-lock"),a.style.cursor=""))}showStatus(t,e="info"){var a=document.getElementById("verification-status");a&&(a.style.display="block",a.className="verification-status "+e,a.innerHTML=`<i class="fa ${{info:"fa-info-circle",success:"fa-check-circle",error:"fa-times-circle"}[e]}"></i> `+t)}hideStatus(){var t=document.getElementById("verification-status");t&&(t.style.display="none")}rebuildTOC(){try{var e=document.getElementById("decrypted-content");let t=document.querySelector(".post-toc-wrap");var a=document.querySelector(".sidebar-inner"),r=window.NexT?.utils;if(e&&t){var s,i=e.querySelectorAll("h1,h2,h3,h4,h5,h6");if(i.length){var n=Array.from(i).reduce((t,e,a)=>{e.id||(e.id="heading-"+a);for(var r=parseInt(e.tagName[1],10),a={level:r,id:e.id,text:e.textContent.trim(),children:[]};t.stack.length&&t.stack.at(-1).level>=r;)t.stack.pop();return(t.stack.length?t.stack.at(-1).children:t.roots).push(a),t.stack.push(a),t},{roots:[],stack:[]}).roots;let r=(t,a=1)=>t.map(t=>{var e=`<a class="nav-link" href="#${t.id}"><span class="nav-text">${t.text}</span></a>`,t=t.children.length?`<ol class="nav-child">${r(t.children,a+1)}</ol>`:"";return`<li class="nav-item nav-level-${a}">${e}${t}</li>`}).join("");(t.querySelector(".post-toc")||((o=document.createElement("div")).className="post-toc animated",t.appendChild(o),o)).innerHTML=`<ol class="nav">${r(n)}</ol>`,a?.classList.add("sidebar-nav-active","sidebar-toc-active"),a?.classList.remove("sidebar-overview-active")}else(s=t.querySelector(".post-toc"))&&(s.innerHTML=""),a?.classList.remove("sidebar-nav-active","sidebar-toc-active"),a?.classList.add("sidebar-overview-active");r?.registerSidebarTOC?.()}}catch(t){console.error("TOC 重建失败: "+t.message)}var o}triggerPageLoadedEvent(){document.dispatchEvent(new Event("page:loaded",{bubbles:!0}))}renderRefresh(){this.rebuildTOC(),NexT?.boot?.refresh?.(),this.triggerPageLoadedEvent()}b64ToAB(t){var e=atob(t),a=new Uint8Array(e.length);for(let t=0;t<e.length;t++)a[t]=e.charCodeAt(t);return a.buffer}}let decryptor=new Decryptor;document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".encrypted-post-container")&&decryptor.init()});