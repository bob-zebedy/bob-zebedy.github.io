<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>注册通行密钥</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, "PingFang SC", "Microsoft YaHei", "sans-serif";
        background: white;
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 60px 20px 20px;
      }

      .container {
        border-radius: 16px;
        max-width: 650px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
        text-align: center;
      }

      .subtitle {
        color: #666;
        text-align: center;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .register-btn {
        width: 100%;
        padding: 15px;
        background: #059669;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .register-btn:hover:not(:disabled) {
        background: #047857;
      }

      .register-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #9ca3af;
      }

      .register-btn i {
        margin-right: 10px;
      }

      #status {
        margin-top: 20px;
        display: none;
      }

      .note {
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .note.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .note.danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .note.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .note code {
        display: block;
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        font-size: 12px;
        font-family: "Monaco", "Courier New", monospace;
        user-select: all;
        word-break: break-all;
        margin: 10px auto;
        text-align: center;
      }

      .copy-btn {
        display: block;
        padding: 8px 16px;
        background: #0284c7;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 10px auto 0;
      }

      .copy-btn:hover {
        background: #0369a1;
      }

      .copy-btn i {
        margin-right: 5px;
      }

      .salt-container {
        margin-bottom: 20px;
      }

      .salt-container label {
        display: block;
        margin-bottom: 8px;
        color: #666;
        font-size: 14px;
      }

      .salt-container input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>注册通行密钥</h1>
      <p class="subtitle">
        使用 YubiKey、Touch ID 或其他 FIDO2 设备保护您的加密内容
      </p>

      <div class="salt-container">
        <label for="prf-salt-input"
          >PRF Salt <span style="color: #ef4444">*</span></label
        >
        <input type="text" id="prf-salt-input" placeholder="" required />
      </div>

      <button class="register-btn" id="register-btn">
        <i class="fa fa-key"></i> 开始注册
      </button>

      <div id="status"></div>
    </div>

    <script>
      function getRPID() {
        const hostname = location.hostname;
        return hostname === "127.0.0.1" ? "localhost" : hostname;
      }

      class FIDO2Registrar {
        constructor() {
          this.btn = document.getElementById("register-btn");
          this.saltInput = document.getElementById("prf-salt-input");

          this.btn.onclick = () => this.register();
          this.saltInput.addEventListener("input", () => this.validateInput());
          this.validateInput();
        }

        validateInput() {
          const isValid = this.saltInput.value.trim().length > 0;
          this.btn.disabled = !isValid;
        }

        async register() {
          this.btn.disabled = true;

          if (!window.PublicKeyCredential) {
            this.show(
              '<div class="note danger"><p>浏览器不支持 FIDO2/WebAuthn</p></div>'
            );
            this.btn.disabled = false;
            return;
          }

          this.show('<div class="note info"><p>正在注册通行密钥...</p></div>');

          try {
            const userId = crypto.getRandomValues(new Uint8Array(32));
            const challenge = crypto.getRandomValues(new Uint8Array(32));

            const cred = await navigator.credentials.create({
              publicKey: {
                challenge,
                rp: {
                  name: "Undefined Blog",
                  id: getRPID(),
                },
                user: {
                  id: userId,
                  name: "Zabrian",
                  displayName: "Zabrian",
                },
                pubKeyCredParams: [
                  { alg: -7, type: "public-key" },
                  { alg: -257, type: "public-key" },
                ],
                authenticatorSelection: {
                  residentKey: "required",
                  userVerification: "preferred",
                  requireResidentKey: true,
                },
                timeout: 60000,
                extensions: {
                  prf: {},
                },
              },
            });

            if (!cred) throw new Error("生成凭证失败");

            const prfEnabled = cred.getClientExtensionResults().prf?.enabled;
            if (!prfEnabled) {
              this.show('<div class="note danger"><p>PRF 扩展不可用</p></div>');
              this.btn.disabled = false;
              return;
            }

            await this.generateEncryptionKey();

            this.btn.style.display = "none";
          } catch (e) {
            let msg = "注册失败: ";
            if (e.name === "NotAllowedError") msg += "操作取消";
            else if (e.name === "InvalidStateError") msg += "重复注册";
            else msg += e.message;

            this.show(`<div class="note danger"><p>${msg}</p></div>`);
          } finally {
            this.btn.disabled = false;
          }
        }

        async generateEncryptionKey() {
          try {
            const prfSaltString = this.saltInput.value.trim();

            this.show(
              '<div class="note info"><p>正在生成加密密钥...</p></div>'
            );

            const challenge = crypto.getRandomValues(new Uint8Array(32));
            const prfSalt = await crypto.subtle.digest(
              "SHA-256",
              new TextEncoder().encode(prfSaltString)
            );

            const assertion = await navigator.credentials.get({
              publicKey: {
                challenge,
                rpId: getRPID(),
                userVerification: "preferred",
                timeout: 60000,
                extensions: {
                  prf: {
                    eval: { first: prfSalt },
                  },
                },
              },
            });

            const prfKey =
              assertion.getClientExtensionResults().prf?.results?.first;
            if (!prfKey) throw new Error("无法获取 PRF 密钥");

            const encryptionKey = new Uint8Array(prfKey);
            const encryptionKeyHex = Array.from(encryptionKey)
              .map((b) => b.toString(16).padStart(2, "0"))
              .join("");

            this.show(`
              <div class="note success">
                <p>
                  <code id="encryption-key">${encryptionKeyHex}</code>
                  <button class="copy-btn" onclick="copyEncryptionKey(event)">
                    <i class="fa fa-copy"></i> 复制密钥
                  </button>
                </p>
              </div>`);
          } catch (e) {
            this.show(
              `<div class="note danger"><p>生成密钥失败: ${e.message}</p></div>`
            );
          }
        }

        show(html) {
          document.getElementById("status").innerHTML = html;
          document.getElementById("status").style.display = "block";
        }
      }

      function copyEncryptionKey(event) {
        const key = document.getElementById("encryption-key").textContent;
        navigator.clipboard.writeText(key).then(() => {
          const btn = event.target.closest("button");
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="fa fa-check"></i> 已复制';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        });
      }

      document.addEventListener("DOMContentLoaded", () => new FIDO2Registrar());
    </script>
  </body>
</html>
